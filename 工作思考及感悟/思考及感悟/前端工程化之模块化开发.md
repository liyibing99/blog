# 前端工程化之模块化开发

模块化开发是前端工程化的核心概念之一，它将复杂的代码拆分成独立、可复用的模块，提高代码的可维护性和可扩展性。本文将全面介绍前端模块化开发的各个方面。

## 模块化概述

### 什么是模块化

模块化是将复杂的系统分解为多个独立、可管理的模块的过程。每个模块都有明确的职责和接口，可以独立开发、测试和维护。

### 模块化的优势

1. **代码复用**：模块可以在多个地方重复使用
2. **关注点分离**：每个模块专注于特定的功能
3. **易于维护**：修改某个模块不会影响其他模块
4. **便于测试**：可以独立测试每个模块
5. **团队协作**：不同开发者可以并行开发不同模块
6. **按需加载**：可以按需加载模块，提高性能

## JavaScript 模块化

### 1. CommonJS

#### 基本语法

```javascript
// 导出模块
// math.js
function add(a, b) {
  return a + b
}

function subtract(a, b) {
  return a - b
}

// 单个导出
module.exports = add

// 多个导出
module.exports = {
  add,
  subtract
}

// 或者使用 exports
exports.add = add
exports.subtract = subtract
```

```javascript
// 导入模块
// app.js
const add = require('./math')
const { add: sum, subtract } = require('./math')

console.log(add(1, 2))
console.log(sum(3, 4))
console.log(subtract(5, 3))
```

#### 动态导入

```javascript
// 动态加载模块
const loadModule = async () => {
  const math = await import('./math')
  console.log(math.add(1, 2))
}

loadModule()
```

### 2. ES Modules (ESM)

#### 基本语法

```javascript
// 导出模块
// math.js
export function add(a, b) {
  return a + b
}

export function subtract(a, b) {
  return a - b
}

// 默认导出
export default function multiply(a, b) {
  return a * b
}

// 或者
const divide = (a, b) => a / b
export { divide }
```

```javascript
// 导入模块
// app.js
import multiply from './math'
import { add, subtract } from './math'
import * as math from './math'

console.log(multiply(2, 3))
console.log(add(1, 2))
console.log(subtract(5, 3))
console.log(math.add(1, 2))
```

#### 动态导入

```javascript
// 动态导入
const loadModule = async () => {
  const math = await import('./math')
  console.log(math.default(2, 3))
  console.log(math.add(1, 2))
}

loadModule()
```

#### 重新导出

```javascript
// 重新导出
// utils/index.js
export { formatDate } from './format'
export { validateEmail } from './validate'
export * from './helpers'

// 默认重新导出
export { default } from './math'
```

### 3. UMD (Universal Module Definition)

```javascript
// umd.js
(function (root, factory) {
  if (typeof define === 'function' && define.amd) {
    // AMD
    define([], factory)
  } else if (typeof module === 'object' && module.exports) {
    // CommonJS
    module.exports = factory()
  } else {
    // Browser globals
    root.myModule = factory()
  }
}(typeof self !== 'undefined' ? self : this, function () {
  return {
    add: function (a, b) {
      return a + b
    }
  }
}))
```

## CSS 模块化

### 1. CSS Modules

#### 基本使用

```javascript
// Button.jsx
import styles from './Button.module.css'

function Button({ children, onClick }) {
  return (
    <button className={styles.button} onClick={onClick}>
      {children}
    </button>
  )
}

export default Button
```

```css
/* Button.module.css */
.button {
  padding: 10px 20px;
  background-color: #007bff;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.button:hover {
  background-color: #0056b3;
}
```

#### 组合使用

```javascript
// Card.jsx
import styles from './Card.module.css'

function Card({ title, content }) {
  return (
    <div className={`${styles.card} ${styles.shadow}`}>
      <h2 className={styles.title}>{title}</h2>
      <p className={styles.content}>{content}</p>
    </div>
  )
}

export default Card
```

```css
/* Card.module.css */
.card {
  padding: 20px;
  border-radius: 8px;
  background-color: white;
}

.shadow {
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
}

.title {
  margin: 0 0 10px 0;
  font-size: 24px;
}

.content {
  margin: 0;
  color: #666;
}
```

### 2. CSS-in-JS

#### Styled Components

```javascript
// Button.jsx
import styled from 'styled-components'

const StyledButton = styled.button`
  padding: 10px 20px;
  background-color: ${props => props.primary ? '#007bff' : '#6c757d'};
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;

  &:hover {
    background-color: ${props => props.primary ? '#0056b3' : '#545b62'};
  }
`

function Button({ children, onClick, primary }) {
  return (
    <StyledButton onClick={onClick} primary={primary}>
      {children}
    </StyledButton>
  )
}

export default Button
```

#### Emotion

```javascript
// Button.jsx
import styled from '@emotion/styled'

const StyledButton = styled.button`
  padding: 10px 20px;
  background-color: ${props => props.primary ? '#007bff' : '#6c757d'};
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;

  &:hover {
    background-color: ${props => props.primary ? '#0056b3' : '#545b62'};
  }
`

function Button({ children, onClick, primary }) {
  return (
    <StyledButton onClick={onClick} primary={primary}>
      {children}
    </StyledButton>
  )
}

export default Button
```

### 3. SCSS 模块化

#### 部分文件

```scss
// _variables.scss
$primary-color: #007bff;
$secondary-color: #6c757d;
$border-radius: 4px;
```

```scss
// _mixins.scss
@mixin button-style($bg-color) {
  padding: 10px 20px;
  background-color: $bg-color;
  color: white;
  border: none;
  border-radius: $border-radius;
  cursor: pointer;

  &:hover {
    background-color: darken($bg-color, 10%);
  }
}
```

```scss
// _buttons.scss
@import 'variables';
@import 'mixins';

.button {
  @include button-style($primary-color);
}

.button-secondary {
  @include button-style($secondary-color);
}
```

```scss
// main.scss
@import 'variables';
@import 'mixins';
@import 'buttons';
```

## 组件模块化

### 1. 函数式组件

```javascript
// components/Button/index.jsx
function Button({ children, onClick, variant = 'primary' }) {
  const buttonStyles = {
    primary: 'bg-blue-500 hover:bg-blue-600',
    secondary: 'bg-gray-500 hover:bg-gray-600',
    danger: 'bg-red-500 hover:bg-red-600'
  }

  return (
    <button
      onClick={onClick}
      className={`px-4 py-2 text-white rounded ${buttonStyles[variant]}`}
    >
      {children}
    </button>
  )
}

export default Button
```

### 2. 组合组件

```javascript
// components/Card/index.jsx
function Card({ children, className = '' }) {
  return (
    <div className={`bg-white rounded-lg shadow-md p-6 ${className}`}>
      {children}
    </div>
  )
}

Card.Header = function CardHeader({ children }) {
  return (
    <div className="text-xl font-bold mb-4">
      {children}
    </div>
  )
}

Card.Body = function CardBody({ children }) {
  return (
    <div className="text-gray-700">
      {children}
    </div>
  )
}

Card.Footer = function CardFooter({ children }) {
  return (
    <div className="mt-4 pt-4 border-t">
      {children}
    </div>
  )
}

export default Card
```

```javascript
// 使用组合组件
import Card from '@/components/Card'

function UserProfile() {
  return (
    <Card>
      <Card.Header>用户资料</Card.Header>
      <Card.Body>
        <p>用户信息内容</p>
      </Card.Body>
      <Card.Footer>
        <Button>编辑</Button>
      </Card.Footer>
    </Card>
  )
}
```

### 3. 高阶组件

```javascript
// components/withLoading/index.jsx
function withLoading(WrappedComponent) {
  return function WithLoadingComponent({ isLoading, ...props }) {
    if (isLoading) {
      return <div className="text-center py-4">加载中...</div>
    }

    return <WrappedComponent {...props} />
  }
}

export default withLoading
```

```javascript
// 使用高阶组件
import withLoading from '@/components/withLoading'

function UserList({ users }) {
  return (
    <ul>
      {users.map(user => (
        <li key={user.id}>{user.name}</li>
      ))}
    </ul>
  )
}

const LoadingUserList = withLoading(UserList)

function App() {
  const [users, setUsers] = useState([])
  const [isLoading, setIsLoading] = useState(true)

  useEffect(() => {
    fetchUsers().then(data => {
      setUsers(data)
      setIsLoading(false)
    })
  }, [])

  return <LoadingUserList users={users} isLoading={isLoading} />
}
```

## Hooks 模块化

### 1. 自定义 Hooks

```javascript
// hooks/useAuth.js
import { useState, useEffect, useCallback } from 'react'

export function useAuth() {
  const [user, setUser] = useState(null)
  const [isLoading, setIsLoading] = useState(true)

  const login = useCallback(async (credentials) => {
    const response = await fetch('/api/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(credentials)
    })

    const data = await response.json()
    setUser(data.user)
    localStorage.setItem('token', data.token)
    return data
  }, [])

  const logout = useCallback(() => {
    setUser(null)
    localStorage.removeItem('token')
  }, [])

  useEffect(() => {
    const token = localStorage.getItem('token')
    if (token) {
      fetchUser(token).then(setUser)
    }
    setIsLoading(false)
  }, [])

  return { user, isLoading, login, logout }
}
```

```javascript
// hooks/useFetch.js
import { useState, useEffect, useCallback } from 'react'

export function useFetch(url, options = {}) {
  const [data, setData] = useState(null)
  const [error, setError] = useState(null)
  const [isLoading, setIsLoading] = useState(true)

  const fetchData = useCallback(async () => {
    setIsLoading(true)
    try {
      const response = await fetch(url, options)
      if (!response.ok) {
        throw new Error('Network response was not ok')
      }
      const data = await response.json()
      setData(data)
      setError(null)
    } catch (error) {
      setError(error)
      setData(null)
    } finally {
      setIsLoading(false)
    }
  }, [url, options])

  useEffect(() => {
    fetchData()
  }, [fetchData])

  return { data, error, isLoading, refetch: fetchData }
}
```

### 2. 组合 Hooks

```javascript
// hooks/useUser.js
import { useAuth } from './useAuth'
import { useFetch } from './useFetch'

export function useUser() {
  const { user, login, logout } = useAuth()
  const { data: userData, isLoading, refetch } = useFetch(
    user ? `/api/users/${user.id}` : null
  )

  return {
    user: userData || user,
    isLoading,
    login,
    logout,
    refresh: refetch
  }
}
```

## 服务模块化

### 1. API 服务

```javascript
// services/api.js
const API_BASE_URL = process.env.API_BASE_URL || 'http://localhost:3000/api'

class ApiService {
  constructor(baseURL) {
    this.baseURL = baseURL
    this.headers = {
      'Content-Type': 'application/json'
    }
  }

  setAuthToken(token) {
    this.headers['Authorization'] = `Bearer ${token}`
  }

  async request(endpoint, options = {}) {
    const url = `${this.baseURL}${endpoint}`
    const config = {
      ...options,
      headers: {
        ...this.headers,
        ...options.headers
      }
    }

    const response = await fetch(url, config)

    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`)
    }

    return response.json()
  }

  get(endpoint) {
    return this.request(endpoint, { method: 'GET' })
  }

  post(endpoint, data) {
    return this.request(endpoint, {
      method: 'POST',
      body: JSON.stringify(data)
    })
  }

  put(endpoint, data) {
    return this.request(endpoint, {
      method: 'PUT',
      body: JSON.stringify(data)
    })
  }

  delete(endpoint) {
    return this.request(endpoint, { method: 'DELETE' })
  }
}

export const api = new ApiService(API_BASE_URL)
```

### 2. 业务服务

```javascript
// services/userService.js
import { api } from './api'

export const userService = {
  async getUsers() {
    return api.get('/users')
  },

  async getUserById(id) {
    return api.get(`/users/${id}`)
  },

  async createUser(userData) {
    return api.post('/users', userData)
  },

  async updateUser(id, userData) {
    return api.put(`/users/${id}`, userData)
  },

  async deleteUser(id) {
    return api.delete(`/users/${id}`)
  }
}
```

```javascript
// services/productService.js
import { api } from './api'

export const productService = {
  async getProducts(params = {}) {
    const queryString = new URLSearchParams(params).toString()
    return api.get(`/products?${queryString}`)
  },

  async getProductById(id) {
    return api.get(`/products/${id}`)
  },

  async createProduct(productData) {
    return api.post('/products', productData)
  },

  async updateProduct(id, productData) {
    return api.put(`/products/${id}`, productData)
  },

  async deleteProduct(id) {
    return api.delete(`/products/${id}`)
  }
}
```

## 工具模块化

### 1. 日期工具

```javascript
// utils/date.js
export function formatDate(date, format = 'YYYY-MM-DD') {
  const d = new Date(date)
  const year = d.getFullYear()
  const month = String(d.getMonth() + 1).padStart(2, '0')
  const day = String(d.getDate()).padStart(2, '0')
  const hours = String(d.getHours()).padStart(2, '0')
  const minutes = String(d.getMinutes()).padStart(2, '0')
  const seconds = String(d.getSeconds()).padStart(2, '0')

  return format
    .replace('YYYY', year)
    .replace('MM', month)
    .replace('DD', day)
    .replace('HH', hours)
    .replace('mm', minutes)
    .replace('ss', seconds)
}

export function formatRelativeTime(date) {
  const now = new Date()
  const diff = now - new Date(date)
  const seconds = Math.floor(diff / 1000)
  const minutes = Math.floor(seconds / 60)
  const hours = Math.floor(minutes / 60)
  const days = Math.floor(hours / 24)

  if (days > 0) return `${days}天前`
  if (hours > 0) return `${hours}小时前`
  if (minutes > 0) return `${minutes}分钟前`
  return '刚刚'
}

export function isToday(date) {
  const today = new Date()
  const d = new Date(date)
  return d.toDateString() === today.toDateString()
}
```

### 2. 验证工具

```javascript
// utils/validate.js
export function validateEmail(email) {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
  return emailRegex.test(email)
}

export function validatePhone(phone) {
  const phoneRegex = /^1[3-9]\d{9}$/
  return phoneRegex.test(phone)
}

export function validateIdCard(idCard) {
  const idCardRegex = /(^\d{15}$)|(^\d{18}$)|(^\d{17}(\d|X|x)$)/
  return idCardRegex.test(idCard)
}

export function validatePassword(password) {
  return password.length >= 8
}
```

### 3. 存储工具

```javascript
// utils/storage.js
export const storage = {
  get(key, defaultValue = null) {
    try {
      const item = localStorage.getItem(key)
      return item ? JSON.parse(item) : defaultValue
    } catch (error) {
      console.error('Error reading from localStorage:', error)
      return defaultValue
    }
  },

  set(key, value) {
    try {
      localStorage.setItem(key, JSON.stringify(value))
    } catch (error) {
      console.error('Error writing to localStorage:', error)
    }
  },

  remove(key) {
    try {
      localStorage.removeItem(key)
    } catch (error) {
      console.error('Error removing from localStorage:', error)
    }
  },

  clear() {
    try {
      localStorage.clear()
    } catch (error) {
      console.error('Error clearing localStorage:', error)
    }
  }
}
```

## 模块打包

### 1. Webpack 配置

```javascript
// webpack.config.js
const path = require('path')

module.exports = {
  entry: './src/index.js',
  output: {
    path: path.resolve(__dirname, 'dist'),
    filename: 'bundle.js',
    library: 'MyLibrary',
    libraryTarget: 'umd'
  },
  module: {
    rules: [
      {
        test: /\.js$/,
        exclude: /node_modules/,
        use: {
          loader: 'babel-loader'
        }
      },
      {
        test: /\.css$/,
        use: ['style-loader', 'css-loader']
      }
    ]
  },
  externals: {
    react: 'react',
    'react-dom': 'react-dom'
  }
}
```

### 2. Rollup 配置

```javascript
// rollup.config.js
export default {
  input: 'src/index.js',
  output: [
    {
      file: 'dist/bundle.cjs.js',
      format: 'cjs'
    },
    {
      file: 'dist/bundle.esm.js',
      format: 'esm'
    },
    {
      file: 'dist/bundle.umd.js',
      format: 'umd',
      name: 'MyLibrary'
    }
  ],
  external: ['react', 'react-dom']
}
```

### 3. Vite 配置

```javascript
// vite.config.js
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  build: {
    lib: {
      entry: 'src/index.js',
      name: 'MyLibrary',
      fileName: (format) => `bundle.${format}.js`
    },
    rollupOptions: {
      external: ['react', 'react-dom'],
      output: {
        globals: {
          react: 'React',
          'react-dom': 'ReactDOM'
        }
      }
    }
  }
})
```

## 最佳实践

### 1. 模块设计原则

```javascript
// 单一职责原则
// 好的例子
// userService.js - 只负责用户相关的操作
export const userService = {
  async getUsers() { },
  async getUserById(id) { },
  async createUser(userData) { }
}

// 不好的例子
// service.js - 职责过多
export const service = {
  async getUsers() { },
  async getProducts() { },
  async sendEmail() { },
  async uploadFile() { }
}
```

### 2. 依赖管理

```javascript
// 使用依赖注入
// 好的例子
class UserService {
  constructor(apiClient) {
    this.apiClient = apiClient
  }

  async getUsers() {
    return this.apiClient.get('/users')
  }
}

// 不好的例子 - 硬编码依赖
class UserService {
  async getUsers() {
    return fetch('/api/users')
  }
}
```

### 3. 模块导出

```javascript
// 好的例子 - 清晰的导出
export { userService } from './services/userService'
export { productService } from './services/productService'
export { formatDate } from './utils/date'
export { validateEmail } from './utils/validate'

// 不好的例子 - 混乱的导出
export * from './services/userService'
export * from './services/productService'
export * from './utils/date'
export * from './utils/validate'
```

### 4. 模块文档

```javascript
/**
 * 用户服务模块
 * @module services/userService
 */

/**
 * 获取所有用户
 * @async
 * @returns {Promise<Array>} 用户列表
 * @throws {Error} 当请求失败时抛出错误
 */
export async function getUsers() {
  // 实现
}

/**
 * 根据 ID 获取用户
 * @async
 * @param {string} id - 用户 ID
 * @returns {Promise<Object>} 用户对象
 * @throws {Error} 当用户不存在时抛出错误
 */
export async function getUserById(id) {
  // 实现
}
```

## 总结

模块化开发是前端工程化的核心，需要：

1. **选择合适的模块化方案**：根据项目需求选择 CommonJS、ESM 或 UMD
2. **保持模块独立性**：每个模块应该有明确的职责和接口
3. **遵循设计原则**：单一职责、开闭原则、依赖倒置等
4. **编写清晰的文档**：为模块编写使用文档和 API 文档
5. **进行模块测试**：确保每个模块都能正常工作
6. **优化模块加载**：使用按需加载和代码分割提高性能

通过模块化开发，可以大大提高代码的可维护性和可扩展性。记住，好的模块化设计是构建大型前端应用的基础。